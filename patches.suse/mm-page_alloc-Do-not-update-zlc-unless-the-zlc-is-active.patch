From 1603df9b1511d89a82d72547694dff7e9bb037d6 Mon Sep 17 00:00:00 2001
From: Mel Gorman <mgorman@suse.de>
Date: Thu, 3 Apr 2014 20:08:20 +0100
Subject: [PATCH] mm: page_alloc: Do not update zlc unless the zlc is active

References: VM/FS Performance
Patch-mainline: v3.16
Git-commit: 65bb371984d6a2c909244eb749e482bb40b72e36

The zlc is used on NUMA machines to quickly skip over zones that are full.
However it is always updated, even for the first zone scanned when the
zlc might not even be active. As it's a write to a bitmap that potentially
bounces cache line it's deceptively expensive and most machines will not
care. Only update the zlc if it was active.

Signed-off-by: Mel Gorman <mgorman@suse.de>
---
 mm/page_alloc.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/mm/page_alloc.c b/mm/page_alloc.c
index cfbdd62..27d2eb3 100644
--- a/mm/page_alloc.c
+++ b/mm/page_alloc.c
@@ -2026,7 +2026,7 @@ try_this_zone:
 		if (page)
 			break;
 this_zone_full:
-		if (IS_ENABLED(CONFIG_NUMA))
+		if (IS_ENABLED(CONFIG_NUMA) && zlc_active)
 			zlc_mark_zone_full(zonelist, z);
 	}
 
